<div align="center">

# üõ°Ô∏è Malware Protection Guide

**ClamAV Antivirus Installation and Configuration**

[![Antivirus](https://img.shields.io/badge/Antivirus-ClamAV-blue)]()
[![Difficulty](https://img.shields.io/badge/Difficulty-Beginner-green)]()

*Protect your Linux server from malware with ClamAV and automated scanning*

---

</div>

## üìã Overview

This guide will walk you through setting up ClamAV (Clam AntiVirus) on your Linux server to:

- ‚úÖ Install and configure ClamAV antivirus
- ‚úÖ Set up automatic signature updates
- ‚úÖ Schedule regular system scans
- ‚úÖ Configure email alerts for threats
- ‚úÖ Optimize scan performance

> üí° **Note:** ClamAV is an open-source antivirus engine for detecting trojans, viruses, malware, and other malicious threats on Linux systems.

---

## üöÄ Step-by-Step Guide

### Step 1: Install ClamAV

#### 1.1 Install on Ubuntu/Debian

```bash
# Update package list
sudo apt update

# Install ClamAV and ClamAV-daemon
sudo apt install clamav clamav-daemon -y

# Install additional tools
sudo apt install clamav-freshclam clamav-unofficial-sigs -y
```

#### 1.2 Install on CentOS/RHEL/Fedora

**For CentOS/RHEL:**
```bash
# Install EPEL repository
sudo yum install epel-release -y

# Install ClamAV
sudo yum install clamav clamav-update -y
```

**For Fedora:**
```bash
sudo dnf install clamav clamav-update -y
```

#### 1.3 Verify Installation

```bash
# Check ClamAV version
clamscan --version

# Check if services are installed
systemctl status clamav-daemon 2>/dev/null || systemctl status clamd
```

---

### Step 2: Update Virus Definitions

Before running any scans, update the virus signature database.

#### 2.1 Stop ClamAV Services (Required for Update)

```bash
# Ubuntu/Debian
sudo systemctl stop clamav-freshclam

# CentOS/RHEL/Fedora
sudo systemctl stop clamd
```

#### 2.2 Update Virus Definitions

```bash
# Update signatures manually
sudo freshclam
```

This may take a few minutes on first run as it downloads the entire database.

#### 2.3 Start and Enable Automatic Updates

```bash
# Start freshclam service
sudo systemctl start clamav-freshclam

# Enable to start on boot
sudo systemctl enable clamav-freshclam

# Start ClamAV daemon
sudo systemctl start clamav-daemon
# Or on CentOS/RHEL:
sudo systemctl start clamd

# Enable on boot
sudo systemctl enable clamav-daemon
# Or:
sudo systemctl enable clamd
```

#### 2.4 Verify Updates are Working

```bash
# Check freshclam status
sudo systemctl status clamav-freshclam

# Check last update time
sudo cat /var/log/clamav/freshclam.log | tail -20

# Check database location and size
ls -lh /var/lib/clamav/
```

---

### Step 3: Configure ClamAV

#### 3.1 Configure Freshclam (Signature Updates)

Edit the freshclam configuration:

```bash
sudo vi /etc/clamav/freshclam.conf
```

**Important settings to configure:**

```bash
# Number of database checks per day (default: 12)
Checks 24

# Maximum attempts to download database
DatabaseMirror db.local.clamav.net
DatabaseMirror database.clamav.net

# Enable verbose logging
Verbose yes

# Log file location
LogFile /var/log/clamav/freshclam.log

# Disable DNS check (if having update issues)
DNSDatabaseInfo current.cvd.clamav.net
```

#### 3.2 Configure ClamAV Daemon (clamd.conf)

Edit the daemon configuration:

```bash
sudo vi /etc/clamav/clamd.conf
```

**Uncomment and configure these settings:**

```bash
# Remove example configuration comment
# Example

# Local socket path
LocalSocket /var/run/clamav/clamd.ctl

# Fix permissions for socket
FixStaleSocket true

# User and group
User clamav
Group clamav

# Maximum file size to scan (in bytes, 100MB default)
MaxFileSize 100M

# Maximum number of files in a scan
MaxScanSize 100M

# Maximum recursion depth for archives
MaxRecursion 16

# Maximum files in archive
MaxFiles 10000

# Maximum compression ratio
MaxCompressionRatio 250

# Archive blocking
ArchiveBlockEncrypted false

# Log file
LogFile /var/log/clamav/clamav.log

# Log rotation
LogTime yes
LogRotate yes

# Scan HTML files
ScanHTML yes

# Scan PE (Portable Executable) files
ScanPE yes

# Scan ELF files
ScanELF yes

# Scan OLE2 files (Office documents)
ScanOLE2 yes

# Scan PDF files
ScanPDF yes

# Scan Mail files
ScanMail yes

# Maximum time to scan a single file (in milliseconds)
MaxScanTime 60000
```

#### 3.3 Fix Configuration File Permissions

Remove the `.conf` extension requirement:

```bash
# Ubuntu/Debian
sudo cp /etc/clamav/clamd.conf /etc/clamav/clamd.conf.bak
sudo sed -i 's/^Example$/# Example/' /etc/clamav/clamd.conf
sudo sed -i 's/^# LocalSocket/LocalSocket/' /etc/clamav/clamd.conf
sudo sed -i 's/^# FixStaleSocket/FixStaleSocket/' /etc/clamav/clamd.conf

# CentOS/RHEL - usually already configured
```

#### 3.4 Set Proper Permissions

```bash
# Set ownership
sudo chown -R clamav:clamav /var/lib/clamav
sudo chown -R clamav:clamav /var/log/clamav

# Set permissions
sudo chmod 755 /var/lib/clamav
sudo chmod 755 /var/log/clamav
```

#### 3.5 Restart Services

```bash
# Restart freshclam
sudo systemctl restart clamav-freshclam

# Restart ClamAV daemon
sudo systemctl restart clamav-daemon
# Or:
sudo systemctl restart clamd

# Check status
sudo systemctl status clamav-daemon
sudo systemctl status clamav-freshclam
```

---

### Step 4: Manual Virus Scanning

#### 4.1 Scan Specific Directory

```bash
# Scan a directory
sudo clamscan -r /home

# Scan with infected file report
sudo clamscan -r --bell -i /home

# Scan and remove infected files (USE WITH CAUTION!)
sudo clamscan -r --remove /path/to/scan

# Scan and move infected files to quarantine
sudo clamscan -r --move=/var/quarantine /path/to/scan
```

#### 4.2 Full System Scan

```bash
# Scan entire system (exclude /proc, /sys, /dev)
sudo clamscan -r --bell -i --exclude-dir=/proc --exclude-dir=/sys --exclude-dir=/dev /

# Scan with summary report
sudo clamscan -r / --exclude-dir=/proc --exclude-dir=/sys --exclude-dir=/dev --summary
```

#### 4.3 Scan with Daemon (Faster)

```bash
# Use clamdscan for faster scanning (requires daemon running)
sudo clamdscan /home

# Recursive scan with daemon
sudo clamdscan -r /var/www
```

---

### Step 5: Schedule Regular System Scans

#### 5.1 Create Scan Script

Create a custom scan script:

```bash
sudo vi /usr/local/bin/clamav-scan.sh
```

Add the following content:

```bash
#!/bin/bash

# ClamAV Scheduled Scan Script
# Log file location
LOG_FILE="/var/log/clamav/clamav-scan-$(date +\%Y\%m\%d).log"
EMAIL_RECIPIENT="admin@example.com"  # Change this to your email

# Directories to scan
SCAN_DIRS="/home /var/www /tmp"

# Start scan
echo "Starting ClamAV scan on $(date)" >> "$LOG_FILE"
echo "Scanning directories: $SCAN_DIRS" >> "$LOG_FILE"

# Run scan
clamscan -r -i --bell --move=/var/quarantine $SCAN_DIRS >> "$LOG_FILE" 2>&1

# Check exit status
SCAN_RESULT=$?

# Generate summary
echo "" >> "$LOG_FILE"
echo "Scan completed on $(date)" >> "$LOG_FILE"
echo "Exit code: $SCAN_RESULT" >> "$LOG_FILE"

# Count infected files
INFECTED_COUNT=$(grep -c "FOUND" "$LOG_FILE" || echo "0")

if [ "$INFECTED_COUNT" -gt 0 ]; then
    echo "ALERT: $INFECTED_COUNT infected file(s) found!" >> "$LOG_FILE"
    
    # Send email alert (requires mailutils/postfix)
    # Uncomment and configure if email is set up
    # echo "ClamAV scan found $INFECTED_COUNT infected file(s). Check $LOG_FILE for details." | \
    #     mail -s "ClamAV Alert: Infected Files Found" "$EMAIL_RECIPIENT"
fi

# Clean up old log files (older than 30 days)
find /var/log/clamav/ -name "clamav-scan-*.log" -mtime +30 -delete

exit $SCAN_RESULT
```

Make the script executable:

```bash
sudo chmod +x /usr/local/bin/clamav-scan.sh
```

#### 5.2 Create Quarantine Directory

```bash
sudo mkdir -p /var/quarantine
sudo chown clamav:clamav /var/quarantine
sudo chmod 755 /var/quarantine
```

#### 5.3 Schedule with Cron

Edit the root crontab:

```bash
sudo crontab -e
```

Add scan schedules:

```bash
# Daily scan at 2 AM
0 2 * * * /usr/local/bin/clamav-scan.sh

# Weekly full system scan on Sunday at 3 AM
0 3 * * 0 /usr/local/bin/clamav-full-scan.sh

# Update virus definitions every 6 hours
0 */6 * * * freshclam
```

#### 5.4 Alternative: Systemd Timer (Modern Approach)

Create a systemd service:

```bash
sudo vi /etc/systemd/system/clamav-scan.service
```

Add:
```ini
[Unit]
Description=ClamAV Scheduled Scan
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/clamav-scan.sh
User=root
```

Create a timer:

```bash
sudo vi /etc/systemd/system/clamav-scan.timer
```

Add:
```ini
[Unit]
Description=Run ClamAV scan daily
Requires=clamav-scan.service

[Timer]
OnCalendar=daily
OnCalendar=02:00
Persistent=true

[Install]
WantedBy=timers.target
```

Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable clamav-scan.timer
sudo systemctl start clamav-scan.timer

# Check timer status
sudo systemctl list-timers | grep clamav
```

---

### Step 6: Configure Email Alerts (Optional)

#### 6.1 Install Mail Utilities

**Ubuntu/Debian:**
```bash
sudo apt install mailutils -y
```

**CentOS/RHEL/Fedora:**
```bash
sudo yum install mailx -y
# Or
sudo dnf install mailx -y
```

#### 6.2 Configure Postfix (Simple Setup)

```bash
sudo apt install postfix -y
# Choose "Internet Site" during installation
```

#### 6.3 Update Scan Script for Email

Modify the scan script to send email alerts when threats are found (see Step 5.1).

---

### Step 7: Performance Optimization

#### 7.1 Exclude Unnecessary Directories

Create exclude list:

```bash
sudo vi /etc/clamav/scan-exclude.conf
```

Add directories to exclude:
```
/proc
/sys
/dev
/var/run
/tmp
/media
/mnt
/run
```

Use in scan:
```bash
sudo clamscan -r --exclude-from=/etc/clamav/scan-exclude.conf /
```

#### 7.2 Adjust MaxFileSize

Edit `/etc/clamav/clamd.conf`:
```bash
MaxFileSize 200M  # Increase if scanning large files
```

#### 7.3 Use ClamAV Daemon for Faster Scans

Always use `clamdscan` instead of `clamscan` when the daemon is available:
```bash
# Faster - uses daemon
sudo clamdscan -r /home

# Slower - standalone
sudo clamscan -r /home
```

---

## ‚úÖ Verification Checklist

After setup, verify:

- [ ] ClamAV is installed and running
- [ ] Virus definitions are up to date
- [ ] Freshclam service is running and updating
- [ ] ClamAV daemon is running
- [ ] Manual scan works correctly
- [ ] Scheduled scans are running (check logs)
- [ ] Quarantine directory exists and has proper permissions
- [ ] Log files are being created
- [ ] Email alerts work (if configured)
- [ ] Performance is acceptable

---

## üîß Troubleshooting

### freshclam Fails to Update

**Error: "Can't query current.cvd.clamav.net"**

```bash
# Disable DNS check temporarily
sudo vi /etc/clamav/freshclam.conf
# Comment out: DNSDatabaseInfo

# Try manual update
sudo freshclam --verbose
```

**Error: "Database update process failed"**

```bash
# Remove old database files
sudo rm /var/lib/clamav/*.cvd
sudo rm /var/lib/clamav/*.cld

# Re-download
sudo freshclam
```

### ClamAV Daemon Won't Start

**Check configuration:**
```bash
sudo clamd -c /etc/clamav/clamd.conf --foreground
# This shows detailed error messages
```

**Fix permissions:**
```bash
sudo chown -R clamav:clamav /var/lib/clamav
sudo chown -R clamav:clamav /var/run/clamav
sudo chown -R clamav:clamav /var/log/clamav
```

### Scans Are Too Slow

**Exclude unnecessary directories:**
```bash
sudo clamscan -r --exclude-dir=/proc --exclude-dir=/sys --exclude-dir=/dev /
```

**Use daemon for faster scans:**
```bash
sudo clamdscan -r /path
```

**Adjust max file size:**
```bash
# Edit clamd.conf
MaxFileSize 200M
```

### Scheduled Scans Not Running

**Check cron logs:**
```bash
sudo tail -f /var/log/syslog | grep CRON
# Or
sudo journalctl -u cron -f
```

**Check script permissions:**
```bash
sudo chmod +x /usr/local/bin/clamav-scan.sh
```

**Test script manually:**
```bash
sudo /usr/local/bin/clamav-scan.sh
```

---

## üìö Best Practices

1. ‚úÖ **Update signatures daily** - Keep virus database current
2. ‚úÖ **Schedule regular scans** - Daily quick scans, weekly full scans
3. ‚úÖ **Monitor logs** - Check scan results regularly
4. ‚úÖ **Quarantine infected files** - Don't delete immediately, investigate first
5. ‚úÖ **Optimize scan paths** - Exclude unnecessary directories
6. ‚úÖ **Use daemon mode** - Faster scanning performance
7. ‚úÖ **Set up alerts** - Email notifications for threats
8. ‚úÖ **Test regularly** - Verify scans are working

---

<div align="center">

**üõ°Ô∏è Your server is now protected against malware!**

[‚Üê Back to Handbook](../README.md)

</div>

